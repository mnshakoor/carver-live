<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CARVER Live — Risk & Vulnerability Assessment</title>
  <meta name="description" content="Web app for CARVER target analysis, vulnerability assessment, Pa calculator, 5x5 risk matrix, asset prioritization, live monitoring, and report generation. Runs on GitHub Pages or locally."/>
  <meta name="author" content="M. Nuri Shakoor — ARAC International Inc."/>
  <meta name="keywords" content="CARVER, risk assessment, vulnerability assessment, Pa, likelihood impact, 5x5 matrix, critical infrastructure, security, ISO 31000, INSSA, GISF, DBT, CSO"/>
  <!-- Tailwind Play CDN (no build needed) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            risk1: '#22c55e',  // green
            risk2: '#84cc16',  // lime
            risk3: '#eab308',  // yellow
            risk4: '#f97316',  // orange
            risk5: '#ef4444',  // red
          }
        }
      }
    }
  </script>
  <!-- React 18 via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Day.js -->
  <script src="https://unpkg.com/dayjs@1/dayjs.min.js"></script>
  <!-- SheetJS for Excel import -->
  <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- Chart.js optional (small use) -->
  <script src="https://unpkg.com/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    html, body { height: 100%; }
    .card { @apply bg-white shadow-lg rounded-2xl p-5; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-4 py-2 text-sm font-medium shadow hover:shadow-md focus:outline-none focus:ring; }
    .btn-primary { @apply bg-black text-white; }
    .btn-secondary { @apply bg-gray-100 text-gray-900; }
    .pill { @apply px-2 py-0.5 rounded-md text-xs font-semibold; }
    .input, select { @apply w-full rounded-xl border border-gray-300 px-3 py-2 focus:ring focus:ring-gray-200; }
    .grid-cell { display:flex; align-items:center; justify-content:center; height:56px; border:1px solid rgba(0,0,0,0.06); font-weight:600; border-radius:10px; }
    .grid-cell[data-score="1"]{ background: var(--risk1); }
  </style>
</head>
<body class="min-h-full bg-gray-50 text-gray-900">
  <div id="app"></div>

  <script>
  ;(() => {
    const { useState, useMemo, useEffect, useRef } = React

    // Utility helpers
    const uid = () => Math.random().toString(36).slice(2)
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v))
    const load = (k,d) => { try { return JSON.parse(localStorage.getItem(k)) ?? d } catch(e){ return d } }

    // Critical Infrastructure Sectors reference (US DHS)
    const SECTORS = [
      'Chemical', 'Commercial Facilities', 'Communications', 'Critical Manufacturing',
      'Dams', 'Defense Industrial Base', 'Emergency Services', 'Energy', 'Financial Services',
      'Food and Agriculture', 'Government Facilities', 'Healthcare and Public Health',
      'Information Technology', 'Nuclear Reactors, Materials, and Waste', 'Transportation Systems',
      'Water and Wastewater Systems'
    ]

    // Default configuration
    const defaultConfig = {
      scaleMax: 5,                 // 5 or 10
      method: 'simple-averages',   // default mapping for L and I
      lParams: { parts: ['A','V','Rz'] },
      iParams: { parts: ['C','E','R'] },
      riskMatrix: {
        mapping: 'standard', // standard 1..5 to colors
        labels: ['Very Low','Low','Moderate','High','Extreme']
      },
      prioritizationMetric: 'Pa', // Pa or Total or LxI
      datafeedUrl: '',
      pollSeconds: 300,
      org: 'Your Org',
      reportAuthor: 'Assessor',
    }

    // Default demo assets
    const demoAssets = [
      { id: uid(), name: 'Water Treatment Plant 1', sector: 'Water and Wastewater Systems', type: 'Plant', location: 'City A', status:'Open', owner:'Ops', last: dayjs().format('YYYY-MM-DD'), notes:'',
        scores:{ C:4, A:4, R:3, V:3, E:4, Rz:4 }, dbt:['Hazmat Release','Contamination'], watchers:['cso@example.com'] },
      { id: uid(), name: 'Substation Delta', sector: 'Energy', type: 'Substation', location: 'Region West', status:'Open', owner:'Grid Sec', last: dayjs().format('YYYY-MM-DD'), notes:'',
        scores:{ C:5, A:2, R:4, V:4, E:4, Rz:3 }, dbt:['Ballistic Attack','VBIED'], watchers:[] },
      { id: uid(), name: 'HQ and SCADA', sector: 'Information Technology', type: 'HQ', location: 'Downtown', status:'Mitigating', owner:'CISO', last: dayjs().format('YYYY-MM-DD'), notes:'',
        scores:{ C:4, A:3, R:3, V:3, E:3, Rz:3 }, dbt:['Cyber Attack','Theft'], watchers:[] },
    ]

    // Compute metrics
    function computePa(scores, scaleMax){
      const total = scores.C + scores.A + scores.R + scores.V + scores.E + scores.Rz
      return total / (6 * scaleMax)
    }
    function avg(arr){ return arr.reduce((a,b)=>a+b,0) / arr.length }
    function mapToFive(value, scaleMax){
      // Map average on 1..scaleMax to 1..5 then clamp
      const x = Math.round(((value - 1) / (scaleMax - 1)) * 4) + 1
      return Math.max(1, Math.min(5, x))
    }
    function computeLI(scores, scaleMax, method){
      // Default method uses user preferred simple averages
      const Lavg = avg([scores.A, scores.V, scores.Rz])
      const Iavg = avg([scores.C, scores.E, scores.R])
      return { L: mapToFive(Lavg, scaleMax), I: mapToFive(Iavg, scaleMax), Lraw: Lavg, Iraw: Iavg }
    }
    function riskCellColor(score){
      switch(score){
        case 1: return 'bg-risk1 text-white'
        case 2: return 'bg-risk2 text-gray-900'
        case 3: return 'bg-risk3 text-gray-900'
        case 4: return 'bg-risk4 text-white'
        case 5: return 'bg-risk5 text-white'
        default: return 'bg-gray-200'
      }
    }

    // Components
    function App(){
      const [cfg, setCfg] = useState(load('carver_cfg', defaultConfig))
      const [assets, setAssets] = useState(load('carver_assets', demoAssets))
      const [activeId, setActiveId] = useState(assets?.[0]?.id || null)
      const [feed, setFeed] = useState(null)
      const active = useMemo(()=> assets.find(a=>a.id===activeId) || null, [assets, activeId])

      useEffect(()=> save('carver_cfg', cfg), [cfg])
      useEffect(()=> save('carver_assets', assets), [assets])

      // Poller for monitoring feed
      useEffect(()=>{
        if(!cfg.datafeedUrl) return
        let stop = false
        async function tick(){
          try{
            const res = await fetch(cfg.datafeedUrl + '?t=' + Date.now())
            if(!res.ok) throw new Error('Feed error')
            const json = await res.json()
            if(!stop) setFeed(json)
          }catch(e){ console.warn('Feed fetch failed', e) }
        }
        tick()
        const h = setInterval(tick, Math.max(30, cfg.pollSeconds) * 1000)
        return ()=>{ stop = true; clearInterval(h) }
      }, [cfg.datafeedUrl, cfg.pollSeconds])

      function addAsset(){
        const item = { id: uid(), name: 'New Asset', sector: SECTORS[0], type:'', location:'', status:'Open', owner:'', last: dayjs().format('YYYY-MM-DD'), notes:'',
          scores:{ C:3, A:3, R:3, V:3, E:3, Rz:3 }, dbt:[], watchers:[] }
        setAssets(a=>[item, ...a]); setActiveId(item.id)
      }
      function delAsset(id){
        if(!confirm('Delete this asset')) return
        setAssets(a=>a.filter(x=>x.id!==id))
        if(id===activeId && assets.length>1){ setActiveId(assets[0].id) }
      }
      function updateAsset(id, patch){ setAssets(a=> a.map(x=> x.id===id? {...x, ...patch}: x)) }
      function updateScore(id, key, val){ setAssets(a=> a.map(x=> x.id===id? {...x, scores:{...x.scores, [key]: val}} : x)) }

      function importExcel(file){
        const reader = new FileReader()
        reader.onload = (e) => {
          const data = new Uint8Array(e.target.result)
          const wb = XLSX.read(data, {type: 'array'})
          const ws = wb.Sheets[wb.SheetNames[0]]
          const rows = XLSX.utils.sheet_to_json(ws, {defval:''})
          const mapped = rows.map(r => ({
            id: uid(),
            name: r.Name || r.Asset || r["Asset Name"] || 'Imported Asset',
            sector: r.Sector || SECTORS[0],
            type: r.Type || '',
            location: r.Location || '',
            status: r.Status || 'Open',
            owner: r.Owner || r.Assignee || '',
            last: r.LastAssessed || r.Last || dayjs().format('YYYY-MM-DD'),
            notes: r.Notes || '',
            scores: {
              C: Number(r.C || r.Criticality || 3),
              A: Number(r.A || r.Accessibility || 3),
              R: Number(r.R || r.Recuperability || r.Recoverability || 3),
              V: Number(r.V || r.Vulnerability || 3),
              E: Number(r.E || r.Effect || 3),
              Rz: Number(r.Rz || r.Recognizability || 3),
            },
            dbt: (r.DBT || r.Threats || '').toString().split(/[,;]+/).map(s=>s.trim()).filter(Boolean),
            watchers: (r.Watchers || '').toString().split(/[,;]+/).map(s=>s.trim()).filter(Boolean),
          }))
          setAssets(mapped.concat(assets))
          alert('Import complete. Added ' + mapped.length + ' assets')
        }
        reader.readAsArrayBuffer(file)
      }

      function exportJSON(){
        const blob = new Blob([JSON.stringify({ cfg, assets }, null, 2)], {type:'application/json'})
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a'); a.href=url; a.download='carver-live-data.json'; a.click(); URL.revokeObjectURL(url)
      }
      function exportMD(){
        const lines = []
        lines.push('# CARVER Live Report')
        lines.push('Date: ' + dayjs().format('YYYY-MM-DD'))
        lines.push('Organization: ' + cfg.org)
        lines.push('Assessor: ' + cfg.reportAuthor)
        lines.push('\n## BLUF')
        lines.push('This assessment prioritizes assets using CARVER, calculates Pa, and maps Likelihood and Impact to a 5x5 matrix. Mitigations listed by highest risk first.')
        lines.push('\n## Prioritized Assets')
        const ranked = [...assets].map(a=> withMetrics(a, cfg)).sort((a,b)=> b.rank - a.rank)
        ranked.forEach((a,i)=>{
          lines.push(`\n${i+1}. **${a.name}**  Sector: ${a.sector}  Pa: ${(a.Pa*100).toFixed(0)}%  L×I: ${a.L}×${a.I}  Total: ${a.total}`)
          lines.push(`   - Scores C:${a.scores.C} A:${a.scores.A} R:${a.scores.R} V:${a.scores.V} E:${a.scores.E} Rz:${a.scores.Rz}`)
          lines.push(`   - DBT: ${(a.dbt||[]).join(', ') || 'n/a'}`)
          lines.push(`   - Owner: ${a.owner || 'n/a'}  Status: ${a.status}`)
          lines.push(`   - Notes: ${a.notes || ''}`)
        })
        lines.push('\n## Recommendations')
        lines.push('- Harden top tier assets first, focus on access control, delay, and detection that match DBT assumptions.')
        lines.push('- Establish response time targets aligned to delay layers and geography.')
        lines.push('- Close simple gaps fast. Locks, seals, tamper alarms, vault CCTV, basic cyber hardening.')
        lines.push('- Track mitigations as fields on each asset and re-score CARVER after each change to verify risk reduction.')
        const blob = new Blob([lines.join('\n')], {type:'text/markdown'})
        const url = URL.createObjectURL(blob)
        const a = document.createElement('a'); a.href=url; a.download='CARVER-Live-Report.md'; a.click(); URL.revokeObjectURL(url)
      }
      async function exportPDF(){
        const { jsPDF } = window.jspdf
        const doc = new jsPDF({ unit:'pt', format:'a4' })
        const margin = 40
        let y = margin
        doc.setFont('helvetica','bold'); doc.setFontSize(16)
        doc.text('CARVER Live Report', margin, y); y+=24
        doc.setFont('helvetica',''); doc.setFontSize(10)
        doc.text('Date: ' + dayjs().format('YYYY-MM-DD') + '   Org: ' + cfg.org + '   Assessor: ' + cfg.reportAuthor, margin, y); y+=20
        const ranked = [...assets].map(a=> withMetrics(a, cfg)).sort((a,b)=> b.rank - a.rank)
        ranked.forEach((a, i)=>{
          if(y>760){ doc.addPage(); y=margin }
          doc.setFont('helvetica','bold'); doc.setFontSize(11)
          doc.text(`${i+1}. ${a.name}`, margin, y)
          doc.setFont('helvetica',''); doc.setFontSize(10)
          y+=14
          doc.text(`Sector: ${a.sector}  Pa: ${(a.Pa*100).toFixed(0)}%  L×I: ${a.L}×${a.I}  Total: ${a.total}`, margin, y)
          y+=12
          doc.text(`Scores C:${a.scores.C} A:${a.scores.A} R:${a.scores.R} V:${a.scores.V} E:${a.scores.E} Rz:${a.scores.Rz}`, margin, y)
          y+=12
          doc.text(`DBT: ${(a.dbt||[]).join(', ') || 'n/a'}  Owner: ${a.owner || 'n/a'}  Status: ${a.status}`, margin, y)
          y+=18
        })
        doc.save('CARVER-Live-Report.pdf')
      }

      function withMetrics(a, cfg){
        const total = a.scores.C + a.scores.A + a.scores.R + a.scores.V + a.scores.E + a.scores.Rz
        const Pa = computePa(a.scores, cfg.scaleMax)
        const {L,I,Lraw,Iraw} = computeLI(a.scores, cfg.scaleMax, cfg.method)
        const LxI = L * I
        const rank = cfg.prioritizationMetric==='Total'? total : cfg.prioritizationMetric==='LxI'? LxI : Pa
        return {...a, total, Pa, L, I, Lraw, Iraw, LxI, rank }
      }

      const rankedAssets = useMemo(()=> assets.map(a=> withMetrics(a,cfg)).sort((a,b)=> b.rank - a.rank), [assets, cfg])

      return (
        React.createElement('div', {className:'mx-auto max-w-[1400px] p-4 md:p-6'},
          React.createElement(Header, {cfg, setCfg, addAsset, importExcel, exportJSON, exportMD, exportPDF}),
          React.createElement('div', {className:'grid grid-cols-12 gap-5 mt-4'},
            React.createElement('aside', {className:'col-span-12 lg:col-span-4 space-y-5'},
              React.createElement(AssetsPanel, {assets: rankedAssets, activeId, setActiveId, delAsset, cfg}),
              React.createElement(MonitoringPanel, {cfg, setCfg, feed})
            ),
            React.createElement('main', {className:'col-span-12 lg:col-span-8 space-y-5'},
              active && React.createElement(AssetEditor, {asset: active, cfg, updateAsset, updateScore}),
              React.createElement(RiskMatrix, {assets: rankedAssets, cfg}),
              React.createElement(SettingsPanel, {cfg, setCfg})
            )
          )
        )
      )
    }

    function Header({cfg, setCfg, addAsset, importExcel, exportJSON, exportMD, exportPDF}){
      const fileRef = useRef()
      return (
        React.createElement('div', {className:'flex flex-col md:flex-row md:items-center md:justify-between gap-3'},
          React.createElement('div', {className:'flex items-center gap-3'},
            React.createElement('div', {className:'text-2xl font-bold tracking-tight'}, 'CARVER Live'),
            React.createElement('span', {className:'pill bg-gray-900 text-white'}, 'Single file')
          ),
          React.createElement('div', {className:'flex items-center gap-2 flex-wrap'},
            React.createElement('button', {className:'btn btn-secondary', onClick: addAsset}, 'Add Asset'),
            React.createElement('label', {className:'btn btn-secondary cursor-pointer'},
              'Import Excel',
              React.createElement('input', {type:'file', accept:'.xlsx,.xls', className:'hidden', ref:fileRef, onChange:(e)=>{
                const f = e.target.files[0]; if(f) importExcel(f); e.target.value=''
              }})
            ),
            React.createElement('button', {className:'btn btn-secondary', onClick: exportJSON}, 'Export JSON'),
            React.createElement('button', {className:'btn btn-secondary', onClick: exportMD}, 'Export Markdown'),
            React.createElement('button', {className:'btn btn-primary', onClick: exportPDF}, 'Export PDF')
          )
        )
      )
    }

    function AssetsPanel({assets, activeId, setActiveId, delAsset, cfg}){
      return (
        React.createElement('div', {className:'card'},
          React.createElement('div', {className:'flex items-center justify-between'},
            React.createElement('h2', {className:'text-lg font-semibold'}, 'Assets'),
            React.createElement('div', {className:'text-sm text-gray-500'}, assets.length, ' total')
          ),
          React.createElement('div', {className:'mt-3 space-y-2 max-h-[440px] overflow-auto pr-2'},
            assets.map(a => (
              React.createElement('div', {key:a.id, className:'rounded-xl border p-3 hover:bg-gray-50 cursor-pointer ' + (a.id===activeId? 'ring-2 ring-gray-900' : ''), onClick:()=>setActiveId(a.id)},
                React.createElement('div', {className:'flex items-center justify-between gap-3'},
                  React.createElement('div', null,
                    React.createElement('div', {className:'font-medium'}, a.name),
                    React.createElement('div', {className:'text-xs text-gray-500'}, a.sector)
                  ),
                  React.createElement('div', {className:'text-right'},
                    React.createElement('div', {className:'text-sm font-semibold'}, 'Pa ', (a.Pa*100).toFixed(0),'%'),
                    React.createElement('div', {className:'text-xs text-gray-500'}, 'L×I ', a.L,'×',a.I)
                  )
                ),
                React.createElement('div', {className:'flex items-center justify-between mt-2'},
                  React.createElement('div', {className:'flex gap-1 flex-wrap'},
                    a.dbt.slice(0,3).map(t => React.createElement('span', {key:t, className:'pill bg-gray-100'}, t))
                  ),
                  React.createElement('button', {className:'text-xs text-red-600 hover:underline', onClick:(e)=>{ e.stopPropagation(); delAsset(a.id) }}, 'Delete')
                )
              )
            ))
          )
        )
      )
    }

    function AssetEditor({asset, cfg, updateAsset, updateScore}){
      const s = asset.scores
      const metrics = (function(){
        const total = s.C+s.A+s.R+s.V+s.E+s.Rz
        const Pa = computePa(s, cfg.scaleMax)
        const {L,I,Lraw,Iraw} = computeLI(s, cfg.scaleMax, cfg.method)
        return { total, Pa, L, I, Lraw, Iraw }
      })()

      function sliderRow(label, key){
        return React.createElement('div', {className:'space-y-1'},
          React.createElement('div', {className:'flex items-center justify-between'},
            React.createElement('label', {className:'text-sm font-medium'}, label),
            React.createElement('span', {className:'text-xs text-gray-500'}, s[key])
          ),
          React.createElement('input', {type:'range', min:1, max:cfg.scaleMax, step:1, value:s[key], className:'w-full', onChange:(e)=> updateScore(asset.id, key, Number(e.target.value))})
        )
      }

      return (
        React.createElement('div', {className:'card'},
          React.createElement('div', {className:'flex items-center justify-between'},
            React.createElement('h2', {className:'text-lg font-semibold'}, 'Asset Editor'),
            React.createElement('span', {className:'text-xs text-gray-500'}, 'Scale ', cfg.scaleMax, ' point')
          ),
          React.createElement('div', {className:'grid grid-cols-12 gap-4 mt-3'},
            React.createElement('div', {className:'col-span-12 md:col-span-6 space-y-3'},
              React.createElement(TextField, {label:'Name', value:asset.name, onChange:v=>updateAsset(asset.id,{name:v})}),
              React.createElement(SelectField, {label:'Sector', value:asset.sector, options:SECTORS, onChange:v=>updateAsset(asset.id,{sector:v})}),
              React.createElement(TextField, {label:'Type', value:asset.type, onChange:v=>updateAsset(asset.id,{type:v})}),
              React.createElement(TextField, {label:'Location', value:asset.location, onChange:v=>updateAsset(asset.id,{location:v})}),
              React.createElement(TextField, {label:'Owner', value:asset.owner, onChange:v=>updateAsset(asset.id,{owner:v})}),
              React.createElement(SelectField, {label:'Status', value:asset.status, options:['Open','Mitigating','Closed'], onChange:v=>updateAsset(asset.id,{status:v})}),
              React.createElement(TextField, {label:'Watchers (comma separated emails)', value:asset.watchers.join(', '), onChange:v=>updateAsset(asset.id,{watchers:v.split(',').map(x=>x.trim()).filter(Boolean)})}),
              React.createElement(TextArea, {label:'Notes', value:asset.notes, onChange:v=>updateAsset(asset.id,{notes:v})}),
              React.createElement(TextField, {label:'DBT tags (comma separated)', value:(asset.dbt||[]).join(', '), onChange:v=>updateAsset(asset.id,{dbt:v.split(',').map(x=>x.trim()).filter(Boolean)})}),
            ),
            React.createElement('div', {className:'col-span-12 md:col-span-6 space-y-4'},
              React.createElement('div', {className:'grid grid-cols-2 gap-4'},
                sliderRow('Criticality (C)','C'),
                sliderRow('Accessibility (A)','A'),
                sliderRow('Recuperability (R)','R'),
                sliderRow('Vulnerability (V)','V'),
                sliderRow('Effect (E)','E'),
                sliderRow('Recognizability (Rz)','Rz'),
              ),
              React.createElement('div', {className:'rounded-xl border p-3 grid grid-cols-2 gap-3 text-sm'},
                React.createElement('div', null, React.createElement('div', {className:'text-gray-500'}, 'Total'), React.createElement('div', {className:'text-lg font-semibold'}, metrics.total)),
                React.createElement('div', null, React.createElement('div', {className:'text-gray-500'}, 'Pa'), React.createElement('div', {className:'text-lg font-semibold'}, (metrics.Pa*100).toFixed(0),'%')),
                React.createElement('div', null, React.createElement('div', {className:'text-gray-500'}, 'Likelihood'), React.createElement('div', {className:'text-lg font-semibold'}, metrics.L, '  ', React.createElement('span', {className:'text-xs text-gray-500'}, `(avg ${(metrics.Lraw).toFixed(2)})`))),
                React.createElement('div', null, React.createElement('div', {className:'text-gray-500'}, 'Impact'), React.createElement('div', {className:'text-lg font-semibold'}, metrics.I, '  ', React.createElement('span', {className:'text-xs text-gray-500'}, `(avg ${(metrics.Iraw).toFixed(2)})`))),
              )
            )
          )
        )
      )
    }

    function RiskMatrix({assets, cfg}){
      // Count assets by L,I
      const grid = Array.from({length:5}, ()=> Array.from({length:5}, ()=> []))
      assets.forEach(a=>{ grid[5-a.I][a.L-1].push(a) }) // flip Y for display
      return (
        React.createElement('div', {className:'card'},
          React.createElement('div', {className:'flex items-center justify-between'},
            React.createElement('h2', {className:'text-lg font-semibold'}, '5×5 Risk Matrix'),
            React.createElement('div', {className:'text-sm text-gray-500'}, 'Method: simple averages')
          ),
          React.createElement('div', {className:'mt-4 grid grid-cols-6 gap-2'},
            // Headers
            React.createElement('div', {className:'col-span-1'}),
            [1,2,3,4,5].map(x=> React.createElement('div', {key:'h'+x, className:'text-center text-xs font-semibold text-gray-500'}, 'L ', x)),
            // Rows
            [5,4,3,2,1].map((iy, rIdx)=> (
              React.createElement(React.Fragment, {key:'row'+iy},
                React.createElement('div', {className:'text-right pr-2 text-xs font-semibold text-gray-500 flex items-center justify-end'}, 'I ', iy),
                [1,2,3,4,5].map(ix => {
                  const list = grid[rIdx][ix-1]
                  const severity = Math.max(ix, iy)
                  const colorClass = riskCellColor(severity)
                  return React.createElement('div', {key:'c'+iy+ix, className:'grid-cell ' + colorClass, title:list.map(a=>a.name).join(', ') || 'Empty'}, list.length || '')
                })
              )
            ))
          )
        )
      )
    }

    function MonitoringPanel({cfg, setCfg, feed}){
      return (
        React.createElement('div', {className:'card'},
          React.createElement('div', {className:'flex items-center justify-between'},
            React.createElement('h2', {className:'text-lg font-semibold'}, 'Monitoring'),
            React.createElement('span', {className:'text-xs text-gray-500'}, cfg.datafeedUrl? 'Polling' : 'Disabled')
          ),
          React.createElement('div', {className:'space-y-3 mt-3'},
            React.createElement(TextField, {label:'Data feed URL (JSON)', value:cfg.datafeedUrl, onChange:v=> setCfg({...cfg, datafeedUrl:v})}),
            React.createElement(TextField, {label:'Poll interval seconds', type:'number', value:cfg.pollSeconds, onChange:v=> setCfg({...cfg, pollSeconds:Number(v)||300})}),
            React.createElement('div', {className:'rounded-xl border p-3 text-sm bg-gray-50'},
              React.createElement('div', {className:'font-semibold mb-1'}, 'How live monitoring works'),
              React.createElement('p', null, 'Point this app at a JSON file that your team updates. You can host it in the same GitHub repo that serves this page. Use the GitHub Action template to fetch external signals and push updates.'),
              React.createElement('button', {className:'btn btn-secondary mt-2', onClick: ()=> showWorkflowTemplate() }, 'Show GitHub Action template')
            ),
            feed && React.createElement('div', {className:'rounded-xl border p-3 text-sm'},
              React.createElement('div', {className:'font-semibold'}, 'Latest feed snapshot'),
              React.createElement('pre', {className:'text-xs overflow-auto max-h-56'}, JSON.stringify(feed, null, 2))
            )
          )
        )
      )
    }

    function SettingsPanel({cfg, setCfg}){
      return (
        React.createElement('div', {className:'card'},
          React.createElement('h2', {className:'text-lg font-semibold'}, 'Settings'),
          React.createElement('div', {className:'grid grid-cols-1 md:grid-cols-3 gap-4 mt-3'},
            React.createElement(SelectField, {label:'CARVER scale', value:String(cfg.scaleMax), options:['5','10'], onChange:v=> setCfg({...cfg, scaleMax:Number(v)})}),
            React.createElement(SelectField, {label:'Prioritization metric', value:cfg.prioritizationMetric, options:['Pa','Total','LxI'], onChange:v=> setCfg({...cfg, prioritizationMetric:v})}),
            React.createElement(TextField, {label:'Organization', value:cfg.org, onChange:v=> setCfg({...cfg, org:v})}),
            React.createElement(TextField, {label:'Report author', value:cfg.reportAuthor, onChange:v=> setCfg({...cfg, reportAuthor:v})}),
          ),
          React.createElement('div', {className:'text-xs text-gray-500 mt-3'}, 'Likelihood uses the average of A, V, Rz. Impact uses the average of C, E, R. This aligns with simple and explainable mapping preferred for busy supervisors.')
        )
      )
    }

    function TextField({label, value, onChange, type='text'}){
      return (
        React.createElement('label', {className:'block text-sm'},
          React.createElement('div', {className:'mb-1 font-medium'}, label),
          React.createElement('input', {className:'input', value:value, type, onChange:(e)=> onChange(e.target.value)})
        )
      )
    }
    function TextArea({label, value, onChange}){
      return (
        React.createElement('label', {className:'block text-sm'},
          React.createElement('div', {className:'mb-1 font-medium'}, label),
          React.createElement('textarea', {className:'input min-h-[100px]', value:value, onChange:(e)=> onChange(e.target.value)})
        )
      )
    }
    function SelectField({label, value, options, onChange}){
      return (
        React.createElement('label', {className:'block text-sm'},
          React.createElement('div', {className:'mb-1 font-medium'}, label),
          React.createElement('select', {className:'input', value:value, onChange:(e)=> onChange(e.target.value)},
            options.map(o => React.createElement('option', {key:o, value:o}, o))
          )
        )
      )
    }

    function showWorkflowTemplate(){
      const yaml = `# .github/workflows/update-datafeed.yml\nname: Update CARVER Live feed\non:\n  schedule:\n    - cron: '*/30 * * * *'  # every 30 minutes\n  workflow_dispatch:{}\npermissions:\n  contents: write\njobs:\n  build:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - name: Fetch external signals and write datafeed.json\n        run: |\n          echo '{\"updated\": \"'\`date -u +%Y-%m-%dT%H:%M:%SZ\`'\", \"notes\": \"replace with your integration\"}' > public/datafeed.json\n      - name: Commit\n        run: |\n          git config user.name \"github-actions\"\n          git config user.email \"actions@users.noreply.github.com\"\n          git add public/datafeed.json\n          git commit -m \"chore: update datafeed\" || echo \"No changes\"\n          git push\n`
      const blob = new Blob([yaml], {type:'text/plain'})
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a'); a.href=url; a.download='update-datafeed.yml'; a.click(); URL.revokeObjectURL(url)
      alert('Downloaded GitHub Action template. Place it under .github/workflows in your repo and adjust path to your datafeed.')
    }

    ReactDOM.createRoot(document.getElementById('app')).render(React.createElement(App))
  })()
  </script>

  <!-- Quick help footer -->
  <footer class="text-xs text-gray-500 text-center py-6">
    CARVER Live, single file build. Save this as index.html in a GitHub Pages repo or open locally in a browser.
  </footer>
</body>
</html>

